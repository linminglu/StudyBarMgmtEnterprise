<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>用户管理</title>
        {{template "../public/link/css_inc.html" .}}
        <link href="/static/erp/oem/djd/css/user.css" rel="stylesheet" />
        <link href="/static/erp/oem/djd/css/djd_active.css" rel="stylesheet" />
    </head>
    <body>
        {{template "../public/public/header.html" .}}
        <div class="mainFrme">
            {{template "../public/public/left.html" .}}
            <div class="rightFrme">
                <div class="crumbs"><a href="###">主页</a> > <a href="###">门诊列表</a></div>
                <input type="hidden" name="htag" value="0">
                <div class="cont" id="home_info">
                    <div class="pageHeader">申请信息</div>
                    
                    <div class="f_data" id="scroll_div_1">
                        <dl id="base_info">
                            <dt>基本信息</dt>
                            <dd>
                                <div class="title_info">管家号：</div>
                                <div class="content_info" id="dentalid">
                                    
                                </div>
                            </dd>
                            <dd>
                                <div class="title_info">诊所名称：</div>
                                <div class="content_info" id="clinicname">
                                    1234569
                                </div>
                            </dd>
                            <dd>
                                <div class="title_info">注册时间：</div>
                                <div class="content_info" id="createtime">
                                    2013/06/07 17:21:32
                                </div>
                            </dd>
                            <dd>
                                <div class="title_info">注册人姓名：</div>
                                <div class="content_info" id="contact">
                                    黄小小
                                </div>
                            </dd>
                            <dd>
                                <div class="title_info">注册手机号：</div>
                                <div class="content_info" id="clinicmobile">
                                    18320896666
                                </div>
                            </dd>
                            <dd>
                                <div class="title_info">诊所地址：</div>
                                <div class="content_info" id="clinicaddress">
                                    广东省深圳市南山区西丽大学城
                                </div>
                            </dd>
                            <dd>
                                <div class="title_info">诊所联系方式：</div>
                                <div class="content_info" id="clinicphone">
                                    2633333
                                </div>
                            </dd>
                            <dd>
                                <div class="title_info">营业执照号：</div>
                                <div class="content_info">
                                    <input id="licenseid" type="text" class="sendState" readonly>
                                </div>
                            </dd>
                            <dd>
                                <div class="title_info">营业执照证件照：</div>
                                <div class="content_info">
                                    <input id="licensepic" type="text" class="sendState" readonly>
                                    <a href="javascript:;" class="uploadBtn">上传<input id="upload1" type="file"></a>
                                    <input type="button" class="fillBtn v_img" value="预览" />
                                </div>
                            </dd>
                        </dl>
                        <hr class="m_line">
                        <dl id="base_info">
                            <dt>法人股东信息</dt>
                            <dd>
                                <div class="title_info">法人或股东：</div>
                                <div class="content_info">
                                    <input id="applyerrole" type="text" class="sendState" readonly>
                                </div>
                            </dd>
                            <dd>
                                <div class="title_info">姓名：</div>
                                <div class="content_info">
                                    <input id="applyername" type="text" class="sendState" readonly>
                                </div>
                            </dd>
                            <dd>
                                <div class="title_info">手机号：</div>
                                <div class="content_info">
                                    <input type="text" id="applyermobile" class="sendState" readonly>
                                </div>
                            </dd>
                            <dd>
                                <div class="title_info">身份证号：</div>
                                <div class="content_info">
                                    <input id="idnumber" type="text" class="sendState" readonly>
                                </div>
                            </dd>
                            <dd>
                                <div class="title_info">身份证正面：</div>
                                <div class="content_info">
                                    <input id="idcardfrontpic" type="text" class="sendState" readonly>
                                    <a href="javascript:;" class="uploadBtn">上传<input id="upload2" type="file"></a>
                                    <input type="button" class="fillBtn v_img" value="预览" />
                                </div>
                            </dd>
                            <dd>
                                <div class="title_info">身份证反面：</div>
                                <div class="content_info">
                                    <input id="idcardreversepic" type="text" class="sendState" readonly>
                                    <a href="javascript:;" class="uploadBtn">上传<input id="upload3" type="file"></a>
                                    <input type="button" class="fillBtn v_img" value="预览" />
                                </div>
                            </dd>
                        </dl>
                        <hr class="m_line">
                        <dl class="table_info">
                            <dt>经营信息</dt>
                            <dd>库存金额：1000.000</dd>
                            <dd>牙椅数量：2633333</dd>
                            <dd>
                                <table>
                                    <thead>
                                        <tr>
                                            <th>新增患者</th>
                                            <th>支付宝交易</th>
                                            <th>登录次数</th>
                                            <th>月交易</th>
                                            <th>就诊人次</th>
                                            <th>患者人均频率</th>
                                            <th>日期</th>
                                            <th>预约量</th>
                                            <th>库房出库金额</th>
                                            <th>微信交易</th>
                                        </tr>
                                    </thead>
                                    <tbody id="bodyinfo">
                                        
                                    </tbody>
                                </table>
                            </dd>
                        </dl>
                        <hr class="m_line">
                        <dl id="base_info">
                            <dt>贷款金额</dt>
                            <dd>
                                <div class="title_info">可贷款金额：</div>
                                <div class="content_info">
                                    <input id="maxmoney" type="text" class="sendState" readonly>
                                </div>
                            </dd>
                            <dd>
                                <div class="title_info">期数：</div>
                                <div class="content_info">
                                    <input id="items" type="text" class="sendState" readonly>
                                </div>
                            </dd>
                        </dl>
                    </div>
                </div>
                <div class="m_button">
                    <div class="m_input">
                        <input type="button" class="fillBtn" id="fillBtn" value="提交" />
                        <input type="button" class="uploadBtn del" id="uploadBtn" value="取消" />
                    </div>
                </div>
            </div>
        </div>
        {{template "../public/public/footer.html" .}}
    </body>
    {{template "../public/link/js_inc.html" .}}
    <script>
        var infoid=getUrlParam('infoid');
        $(function(){
            $("input[type='text']").on("input propertychange",function(){
                $(this).removeClass("err_input");
                $(this).siblings(".err_tips").remove();
            });
            $(".v_img").on("click", function() {
                $("#centerDiv").remove();
                var src = $(this).prev().prev("input[type='text']").val();
                var img = "<img src='" + src + "' />";
                if (src == "") {
                    jQuery.loading_close();
                    return;
                } else if (src.indexOf("http") == -1) {
                    jQuery.postFail("fadeInUp", '图片地址错误！！');
                    jQuery.loading_close();
                    return;
                }
                jQuery.loading();
                $(img).load(function() {
                    $("body").append("<div id='centerDiv'>" + img + "<span id='close_ico' title='关闭' onclick='closeFuc()' /></span></div>");
                    var l_h = $(window).height();
                    if ($("#centerDiv img").height() > $(window).height()) {
                         $("#centerDiv img").css({width:'auto',height:$(window).height()+"px"});
                    };
                    $("#centerDiv").css("line-height", l_h + "px");
                    jQuery.loading_close();
                })
            });
            $('#fillBtn').off('click').on('click',function(){
                var infoid=infoid;
                var clinicname=$('#clinicname').text();
                var applyerrole=$('#applyerrole').val();
                var applyername=$('#applyername').val();
                var applyermobile=$('#applyermobile').val();
                var idnumber=$('#idnumber').val();
                var idcardfrontpic=$('#idcardfrontpic').val();
                var idcardreversepic=$('#idcardreversepic').val();
                var licenseid=$('#licenseid').val();
                var licensepic=$('#licensepic').val();
                var items=$('#items').val();
                var maxmoney=$('#maxmoney').val();
                if (clinicname=='') {
                    jQuery.postFail('fadeInUp', '诊所名不能为空');
                    return
                };
                if (applyername=='') {
                    jQuery.postFail('fadeInUp', '申请人姓名不能为空');
                    return
                };
                if (applyermobile=='') {
                    jQuery.postFail('fadeInUp', '申请人手机号不能为空');
                    return
                };
                if (idnumber=='') {
                    jQuery.postFail('fadeInUp', '身份证号不能为空');
                    return
                };
                if (idcardfrontpic=='') {
                    jQuery.postFail('fadeInUp', '身份证正面不能为空');
                    return
                };
                if (idcardreversepic=='') {
                    jQuery.postFail('fadeInUp', '身份证反面不能为空');
                    return
                };
                if (licenseid=='') {
                    jQuery.postFail('fadeInUp', '营业执照号不能为空');
                    return
                };
                if (licensepic=='') {
                    jQuery.postFail('fadeInUp', '营业执照证件照不能为空');
                    return
                };
                if (maxmoney=='') {
                    jQuery.postFail('fadeInUp', '额度不能为空');
                    return
                };
                var obj={
                        "infoid":infoid,   //申请记录ID
                        "clinicname":clinicname,   //诊所名
                        "applyerrole":applyerrole,  //角色(股东、法人)
                        "applyername":applyername,  //申请人姓名
                        "applyermobile":applyermobile,    //申请人手机号
                        "idnumber":idnumber, //身份证号
                        "idcardfrontpic":idcardfrontpic,    //身份证正面
                        "idcardreversepic":idcardreversepic, //身份证反面
                        "licenseid":licenseid,    //营业执照号
                        "licensepic":licensepic,   //营业执照证件照
                        "items":items,   //期数
                        "maxmoney":maxmoney, //额度
                }
                $.post('/butlerp/djd/modifydetaildata',obj,function(data){
                    if (data.code==1) {
                        
                    }else{
                        jQuery.postFail('fadeInUp', data.info);
                    }
                })
            })
            bindUpload()
            getinfo()
        })
        function getinfo(){
            $.ajax({
                  type:"post",
                  url:"/butlerp/djd/getdatedetail",
                  dataType:"json",
                  data :{"infoid":infoid},
                  beforeSend:function(){  
                    jQuery.loading('',-1);
                  },
                  complete: function(json){jQuery.loading_close(-1);},
                  success: function(json){
                        if(json.code==1){
                           givejson(json);
                        }
                  }
            })
        }
        function givejson(json){
            var _list=json.list;
            var applyinfo=_list.applyinfo[0];
            $('#dentalid').text(applyinfo.dentalid);
            $('#clinicname').text(applyinfo.clinicname);
            $('#createtime').text(applyinfo.createtime);
            $('#contact').text(applyinfo.contact);
            $('#clinicmobile').text(applyinfo.clinicmobile);
            $('#clinicaddress').text(applyinfo.clinicaddress);
            $('#clinicphone').text(applyinfo.clinicphone);
            $('#clinic_name').val(applyinfo.clinic_name);
            $('#licenseid').val(applyinfo.licenseid);
            $('#licensepic').val(applyinfo.licensepic);
            $('#idnumber').val(applyinfo.idnumber);
            $('#idcardreversepic').val(applyinfo.idcardreversepic);
            $('#idcardfrontpic').val(applyinfo.idcardfrontpic);
            $('#maxmoney').val(applyinfo.maxmoney);
            $('#items').val(applyinfo.items);
            $('#applyerrole').val(applyinfo.applyerrole);
            $('#applyermobile').val(applyinfo.applyermobile);
            if (_list.clinicinfo) {
                var clinicinfo=_list.clinicinfo;
                    var _tr='';
                $.each(clinicinfo,function(k,v){
                    _tr+=   '   <tr>'+
                            '     <td>'+v.addcustomer+'</td>'+
                            '     <td>'+v.alifee+'</td>'+
                            '     <td>'+v.login+'</td>'+
                            '     <td>'+v.monthfee+'</td>'+
                            '     <td>'+v.patient+'</td>'+
                            '     <td>'+v.patientrate+'</td>'+
                            '     <td>'+v.recorddate+'</td>'+
                            '     <td>'+v.schedule+'</td>'+
                            '     <td>'+v.stockoutfee+'</td>'+
                            '     <td>'+v.wxfee+'</td>'+
                            '   </tr>'
                })
            }else{
                _tr='<tr class="no_data"><td colspan="10"></td></tr>'
            }
            $('#bodyinfo').html(_tr)
        }
        //八个上传图片
        function bindUpload(){
            //企业法人营业执照
            $("#upload1").on("change",function(){
                uploadImg(this,"licensepic");
            });
            //身份证证明
            $("#upload2").on("change",function(){
                uploadImg(this,"idcardfrontpic");
            });
            //身份证反面
            $("#upload3").on("change",function(){
                uploadImg(this,"idcardreversepic");
            });
        }

        //base64位转化
        function uploadImg(obj,id){//传入图片路径，返回base64
            var parmas={};
            var base64="";
            var file=$(obj)[0].files[0];
            var reader = new FileReader(); 
            var readerbase64= new FileReader(); 
            var type=file.type;   //获取图片格式
            console.log(type);
            if(type!="image/jpg"&&type!="image/jpeg"){
                jQuery.postFail("fadeInup","请选择.png或者.jpg格式的图片");
                $("input[type='file']").attr("disabled",false);
                return;
            }
            if($(obj).val()==""){
                $("input[type='file']").attr("disabled",false);
            }
            reader.readAsArrayBuffer(file);
            reader.onloadend=function(e){
                var arr = (new Uint8Array(e.target.result)).subarray(0, 4);
                var header = "";
                for(var i = 0; i < arr.length; i++) {
                    header += arr[i].toString(16);
                }   
                // console.log("arr=",arr)
                switch (header) {
                    case "89504e47":
                        type = "image/png";
                        break;
                    case "47494638":
                        type = "image/gif";
                        break;
                    case "ffd8ffe0":
                    case "ffd8ffe1":
                    case "ffd8ffe2":
                        type = "image/jpeg";
                        break;
                    default:
                        type=file.type;
                        break;
                }
                parmas.ext=type;       //"jpeg/jpg/png三种格式"  
                readerbase64.readAsDataURL(file); 
            }
            $("input[type='file']").attr("disabled",true);
            readerbase64.onload=function(e){
                base64=e.target.result;
                base64=base64.substr(base64.indexOf(',') + 1);
                    parmas.picdata=base64; 
                jQuery.loading();   
                // console.log("parmas",parmas);
                $.post("/paweb/uploadimage",parmas,function(json){
                    jQuery.loading_close(); 
                    $("input[type='file']").attr("disabled",false); 
                    $(obj).val("");
                    if(json.code==1){
                        if(json.list.url==""){
                            jQuery.postFail("fadeInUp","上传图片失败！请重新上传");
                        }else{
                            $("#"+id).val(json.list.url);//成功或返回路径到input中
                            console.log(id)
                            $("#"+id).siblings(".v_img").next(".err_tips").remove();
                            $("#"+id).removeClass("err_input");
                        }
                    }else{
                        jQuery.postFail("fadeInup",json.info)
                    }
                })
            }
        }
        function closeFuc(){
            $("#centerDiv").remove();
            jQuery.loading_close();
        }
        function getUrlParam(name) {
          var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)"); //构造一个含有目标参数的正则表达式对象
          var r = window.location.search.substr(1).match(reg);  //匹配目标参数
          if (r != null) return unescape(r[2]);
            return null; //返回参数值
        }
    </script>
</html>
